#!/bin/bash

#ghetto temporary cronjob to pull some of the stats for swift-recon
#wont work for much beyond the saio at the moment. 

LOCKFILE="/var/lock/swift-recon-object.lock"
if [ -e $LOCKFILE ]; then
    echo "error $0 is already running - cron jobs overlapping ?" 
    echo "$0 lock file present" | /usr/bin/logger -p local0.error
    exit 1
else
    touch $LOCKFILE
fi

if [ -z "$1" ]; then
    LOGFILE="/var/log/swift/storage.log"
else
    LOGFILE=$1
fi

if [ ! -r "$LOGFILE" ]; then
    echo "$0: error $LOGFILE not readable" | /usr/bin/logger -p local2.error
    rm $LOCKFILE
    exit 1
fi

STATSFILE="/var/cache/swift/object.recon"
TMPF=`/bin/mktemp`

asyncs=$(find /srv/[1-4]/node/sd[a-z]1/async_pending/ -type f 2> /dev/null| wc -l)
objrep=$(grep "Object replication complete." $LOGFILE  | tail -n 1 | awk '{print $9}' | sed -e 's/(//g')
objincoming=$(netstat -aln | egrep "tcp.*:6000.*:.*ESTABLISHED" -c)
#objtw=$(netstat -aln | egrep "tcp.*:6000.*:.*TIME_WAIT" -c)

echo "{\"async_pending\":$asyncs, \"object_replication_time\":$objrep, \"object_established_conns\":$objincoming}" > $TMPF

mv -v $TMPF $STATSFILE
rm -f $TMPF $LOCKFILE
exit 0